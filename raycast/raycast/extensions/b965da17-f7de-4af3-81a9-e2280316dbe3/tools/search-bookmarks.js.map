{
  "version": 3,
  "sources": ["../../src/tools/search-bookmarks.ts"],
  "sourcesContent": ["import { getPreferenceValues } from \"@raycast/api\";\n\nimport { Bookmark, BookmarksResponse, CollectionsResponse } from \"../types\";\n\ntype Input = {\n  /**\n   * Free-form text to search for.\n   */\n  query?: string;\n  /**\n   * Tags to narrow the search.\n   */\n  tags?: string[];\n  /**\n   * Raindrop collection id. Defaults to `0` (All bookmarks).\n   */\n  collectionId?: number;\n  /**\n   * Maximum number of items to return. Clamped between 1 and 50.\n   */\n  limit?: number;\n  /**\n   * Optional sort override.\n   */\n  sort?: \"newest\" | \"oldest\" | \"name-asc\" | \"name-desc\" | \"relevance\";\n};\n\ntype SearchResult = {\n  id: number;\n  title: string;\n  url: string;\n  excerpt: string;\n  note: string;\n  tags: string[];\n  collectionId: number;\n  collectionTitle: string;\n  created: string;\n  lastUpdate: string;\n  highlights: { text: string; note: string }[];\n};\n\nconst SORT_MAP: Record<NonNullable<Input[\"sort\"]>, string> = {\n  newest: \"-created\",\n  oldest: \"created\",\n  \"name-asc\": \"title\",\n  \"name-desc\": \"-title\",\n  relevance: \"score\",\n};\n\nexport default async function searchBookmarks(input: Input = {}) {\n  const preferences = getPreferenceValues<Preferences>();\n  const collection = input.collectionId ?? 0;\n  const perPage = clamp(input.limit ?? 10, 1, 50);\n  const url = new URL(`https://api.raindrop.io/rest/v1/raindrops/${collection}`);\n\n  url.searchParams.set(\"perpage\", perPage.toString());\n  const sort = input.sort ? SORT_MAP[input.sort] : preferences.sortBy || \"-created\";\n  if (sort) {\n    url.searchParams.set(\"sort\", sort);\n  }\n\n  const tokens: string[] = [];\n  if (input.query) {\n    tokens.push(input.query);\n  }\n  if (input.tags?.length) {\n    tokens.push(...input.tags.filter(Boolean).map((tag) => `#\"${tag}\"`));\n  }\n  if (tokens.length) {\n    url.searchParams.set(\"search\", tokens.join(\" \").trim());\n  }\n\n  const response = await fetch(url.toString(), {\n    headers: {\n      Authorization: `Bearer ${preferences.token}`,\n    },\n  });\n\n  if (!response.ok) {\n    throw new Error(`Failed to search bookmarks: ${response.statusText}`);\n  }\n\n  const data = (await response.json()) as BookmarksResponse;\n  const items = data.items.slice(0, perPage);\n\n  let collectionTitleMap: Record<number, string> | undefined;\n  if (items.some((bookmark) => bookmark.collection?.$id && !bookmark.collection?.title)) {\n    collectionTitleMap = await fetchCollectionTitleMap(preferences.token);\n  }\n\n  return items.map((bookmark) => mapBookmarkToResult(bookmark, collectionTitleMap));\n}\n\nfunction clamp(value: number, min: number, max: number) {\n  return Math.max(min, Math.min(value, max));\n}\n\nfunction mapBookmarkToResult(bookmark: Bookmark, collectionTitleMap?: Record<number, string>): SearchResult {\n  const collectionId = bookmark.collection?.$id ?? -1;\n  const collectionTitle =\n    bookmark.collection?.title ?? collectionTitleMap?.[collectionId] ?? (collectionId === -1 ? \"Unsorted\" : \"Unknown\");\n\n  return {\n    id: bookmark._id,\n    title: bookmark.title,\n    url: bookmark.link,\n    excerpt: bookmark.excerpt ?? \"\",\n    note: bookmark.note ?? \"\",\n    tags: bookmark.tags ?? [],\n    collectionId,\n    collectionTitle,\n    created: bookmark.created,\n    lastUpdate: bookmark.lastUpdate,\n    highlights: bookmark.highlights?.map((highlight) => ({ text: highlight.text, note: highlight.note })) ?? [],\n  };\n}\n\nasync function fetchCollectionTitleMap(token: string) {\n  try {\n    const response = await fetch(\"https://api.raindrop.io/rest/v1/collections/all\", {\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n    });\n\n    if (!response.ok) {\n      return {};\n    }\n\n    const data = (await response.json()) as CollectionsResponse;\n    return Object.fromEntries(data.items.map((collection) => [collection._id, collection.title]));\n  } catch {\n    return {};\n  }\n}\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAAoC,wBAyC9BC,EAAuD,CAC3D,OAAQ,WACR,OAAQ,UACR,WAAY,QACZ,YAAa,SACb,UAAW,OACb,EAEA,eAAOH,EAAuCI,EAAe,CAAC,EAAG,CAC/D,IAAMC,KAAc,uBAAiC,EAC/CC,EAAaF,EAAM,cAAgB,EACnCG,EAAUC,EAAMJ,EAAM,OAAS,GAAI,EAAG,EAAE,EACxCK,EAAM,IAAI,IAAI,6CAA6CH,CAAU,EAAE,EAE7EG,EAAI,aAAa,IAAI,UAAWF,EAAQ,SAAS,CAAC,EAClD,IAAMG,EAAON,EAAM,KAAOD,EAASC,EAAM,IAAI,EAAIC,EAAY,QAAU,WACnEK,GACFD,EAAI,aAAa,IAAI,OAAQC,CAAI,EAGnC,IAAMC,EAAmB,CAAC,EACtBP,EAAM,OACRO,EAAO,KAAKP,EAAM,KAAK,EAErBA,EAAM,MAAM,QACdO,EAAO,KAAK,GAAGP,EAAM,KAAK,OAAO,OAAO,EAAE,IAAKQ,GAAQ,KAAKA,CAAG,GAAG,CAAC,EAEjED,EAAO,QACTF,EAAI,aAAa,IAAI,SAAUE,EAAO,KAAK,GAAG,EAAE,KAAK,CAAC,EAGxD,IAAME,EAAW,MAAM,MAAMJ,EAAI,SAAS,EAAG,CAC3C,QAAS,CACP,cAAe,UAAUJ,EAAY,KAAK,EAC5C,CACF,CAAC,EAED,GAAI,CAACQ,EAAS,GACZ,MAAM,IAAI,MAAM,+BAA+BA,EAAS,UAAU,EAAE,EAItE,IAAMC,GADQ,MAAMD,EAAS,KAAK,GACf,MAAM,MAAM,EAAGN,CAAO,EAErCQ,EACJ,OAAID,EAAM,KAAME,GAAaA,EAAS,YAAY,KAAO,CAACA,EAAS,YAAY,KAAK,IAClFD,EAAqB,MAAME,EAAwBZ,EAAY,KAAK,GAG/DS,EAAM,IAAKE,GAAaE,EAAoBF,EAAUD,CAAkB,CAAC,CAClF,CAEA,SAASP,EAAMW,EAAeC,EAAaC,EAAa,CACtD,OAAO,KAAK,IAAID,EAAK,KAAK,IAAID,EAAOE,CAAG,CAAC,CAC3C,CAEA,SAASH,EAAoBF,EAAoBD,EAA2D,CAC1G,IAAMO,EAAeN,EAAS,YAAY,KAAO,GAC3CO,EACJP,EAAS,YAAY,OAASD,IAAqBO,CAAY,IAAMA,IAAiB,GAAK,WAAa,WAE1G,MAAO,CACL,GAAIN,EAAS,IACb,MAAOA,EAAS,MAChB,IAAKA,EAAS,KACd,QAASA,EAAS,SAAW,GAC7B,KAAMA,EAAS,MAAQ,GACvB,KAAMA,EAAS,MAAQ,CAAC,EACxB,aAAAM,EACA,gBAAAC,EACA,QAASP,EAAS,QAClB,WAAYA,EAAS,WACrB,WAAYA,EAAS,YAAY,IAAKQ,IAAe,CAAE,KAAMA,EAAU,KAAM,KAAMA,EAAU,IAAK,EAAE,GAAK,CAAC,CAC5G,CACF,CAEA,eAAeP,EAAwBQ,EAAe,CACpD,GAAI,CACF,IAAMZ,EAAW,MAAM,MAAM,kDAAmD,CAC9E,QAAS,CACP,cAAe,UAAUY,CAAK,EAChC,CACF,CAAC,EAED,GAAI,CAACZ,EAAS,GACZ,MAAO,CAAC,EAGV,IAAMa,EAAQ,MAAMb,EAAS,KAAK,EAClC,OAAO,OAAO,YAAYa,EAAK,MAAM,IAAKpB,GAAe,CAACA,EAAW,IAAKA,EAAW,KAAK,CAAC,CAAC,CAC9F,MAAQ,CACN,MAAO,CAAC,CACV,CACF",
  "names": ["search_bookmarks_exports", "__export", "searchBookmarks", "__toCommonJS", "import_api", "SORT_MAP", "input", "preferences", "collection", "perPage", "clamp", "url", "sort", "tokens", "tag", "response", "items", "collectionTitleMap", "bookmark", "fetchCollectionTitleMap", "mapBookmarkToResult", "value", "min", "max", "collectionId", "collectionTitle", "highlight", "token", "data"]
}
