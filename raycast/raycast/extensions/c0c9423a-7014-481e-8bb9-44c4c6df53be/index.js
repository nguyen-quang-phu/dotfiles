"use strict";var L=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var be=Object.prototype.hasOwnProperty;var Ne=(e,t)=>{for(var n in t)L(e,n,{get:t[n],enumerable:!0})},Ce=(e,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let p of Se(t))!be.call(e,p)&&p!==n&&L(e,p,{get:()=>t[p],enumerable:!(a=ye(t,p))||a.enumerable});return e};var we=e=>Ce(L({},"__esModule",{value:!0}),e);var We={};Ne(We,{default:()=>ae});module.exports=we(We);var o=require("@raycast/api"),ie=require("child_process");var Ie=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],$e=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Be=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Ae=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],U=(e,t,n)=>{let a=e;return typeof t=="string"||Array.isArray(t)?a=e.toLocaleString(t,n):(t===!0||n!==void 0)&&(a=e.toLocaleString(void 0,n)),a},O=e=>{if(typeof e=="number")return Math.log10(e);let t=e.toString(10);return t.length+Math.log10(`0.${t.slice(0,15)}`)},Te=e=>typeof e=="number"?Math.log(e):O(e)*Math.log(10),xe=(e,t)=>{if(typeof e=="number")return e/t;let n=e/BigInt(t),a=e%BigInt(t);return Number(n)+Number(a)/t},G=(e,t)=>{if(t===void 0)return e;if(typeof t!="number"||!Number.isSafeInteger(t)||t<0)throw new TypeError(`Expected fixedWidth to be a non-negative integer, got ${typeof t}: ${t}`);return t===0?e:e.length<t?e.padStart(t," "):e},Ee=e=>{let{minimumFractionDigits:t,maximumFractionDigits:n}=e;if(!(t===void 0&&n===void 0))return{...t!==void 0&&{minimumFractionDigits:t},...n!==void 0&&{maximumFractionDigits:n},roundingMode:"trunc"}};function M(e,t){if(typeof e!="bigint"&&!Number.isFinite(e))throw new TypeError(`Expected a finite number, got ${typeof e}: ${e}`);t={bits:!1,binary:!1,space:!0,nonBreakingSpace:!1,...t};let n=t.bits?t.binary?Ae:Be:t.binary?$e:Ie,a=t.space?t.nonBreakingSpace?"\xA0":" ":"",p=typeof e=="number"?e===0:e===0n;if(t.signed&&p){let y=` 0${a}${n[0]}`;return G(y,t.fixedWidth)}let b=e<0,l=b?"-":t.signed?"+":"";b&&(e=-e);let g=Ee(t),C;if(e<1){let y=U(e,t.locale,g);C=l+y+a+n[0]}else{let y=Math.min(Math.floor(t.binary?Te(e)/Math.log(1024):O(e)/3),n.length-1);if(e=xe(e,(t.binary?1024:1e3)**y),!g){let x=Math.max(3,Math.floor(e).toString().length);e=e.toPrecision(x)}let A=U(Number(e),t.locale,g),T=n[y];C=l+A+a+T}return G(C,t.fixedWidth)}var N=require("react");var I=require("react"),Le=()=>{};function Me(e,t){let n=(0,I.useRef)(Le);(0,I.useEffect)(()=>{n.current=e},[e]),(0,I.useEffect)(()=>{if(n.current(),(t??0)>0){let p=Math.max(t??0,1e3),b=setInterval(()=>n.current(),p);return()=>clearInterval(b)}},[t])}var v=Me;var Y=process.platform,B=Y==="darwin",h=Y==="win32";function j(e){return Buffer.from(e,"utf16le").toString("base64")}var _e=`
$result = Get-Process | Where-Object { $_.Id -ne 0 } | ForEach-Object {
  [PSCustomObject]@{
    pid = $_.Id
    name = $_.ProcessName
    cpu = 0
    mem = [math]::Round($_.WorkingSet64 / 1KB, 0)
    path = if ($_.Path) { $_.Path } else { '' }
  }
}
$result | ConvertTo-Json -Compress
`,Fe=`
$cpuCores = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
$processes = Get-CimInstance Win32_PerfFormattedData_PerfProc_Process | Where-Object { $_.IDProcess -ne 0 -and $_.Name -ne '_Total' -and $_.Name -ne 'Idle' }
$result = $processes | ForEach-Object {
  [PSCustomObject]@{
    pid = $_.IDProcess
    cpu = [math]::Round($_.PercentProcessorTime / $cpuCores, 1)
  }
}
$result | ConvertTo-Json -Compress
`;function z(){return h?`powershell -NoLogo -NoProfile -EncodedCommand ${j(_e)}`:"ps -eo pid,ppid,pcpu,rss,comm"}function V(){return h?`powershell -NoLogo -NoProfile -EncodedCommand ${j(Fe)}`:"ps -eo pid,ppid,pcpu,rss,comm"}function Z(e,t=!1){return h?t?`taskkill /F /PID ${e}`:`taskkill /PID ${e}`:t?`zsh -c 'sudo kill -9 ${e}'`:`kill -9 ${e}`}function H(e){let t=e.trim();if(!t)return null;let n=t.match(/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/);if(!n)return null;let[,a,p,b,l,g]=n;return{id:parseInt(a),pid:parseInt(p),cpu:parseFloat(b),mem:parseInt(l),path:g,processName:g.match(/[^/]*$/)?.[0]??""}}function J(e){try{let t=JSON.parse(e);return(Array.isArray(t)?t:[t]).map(a=>({id:a.pid,pid:0,cpu:a.cpu,mem:a.mem,path:a.path||"",processName:a.name||""}))}catch{return console.error("Failed to parse Windows process output"),[]}}function q(e){let t=new Map;try{let n=JSON.parse(e),a=Array.isArray(n)?n:[n];for(let p of a)p?.pid&&t.set(p.pid,p.cpu??0)}catch{console.error("Failed to parse Windows performance output")}return t}function X(e){if(B)return e.includes(".prefPane")?"prefPane":e.includes(".app/")?"app":"binary";if(h){let t=e.toLowerCase();return t.endsWith(".exe")&&(t.includes("program files")||t.includes("applications"))?"app":"binary"}return"binary"}function Q(e,t){return B?e.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]:h?t.replace(/\.exe$/i,""):t}function ee(e){return B?e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns":h?e.type==="app"?{fileIcon:e.path}:"\u{1F5A5}\uFE0F":"\u2699\uFE0F"}function te(e){return B&&e?{title:"Failed to Force Kill Process",message:"Please ensure that touch ID/password prompt is enabled for sudo",helpUrl:"https://dev.to/siddhantkcode/enable-touch-id-authentication-for-sudo-on-macos-sonoma-14x-4d28"}:h&&e?{title:"Failed to Force Kill Process",message:"Administrative privileges may be required. Try running as administrator."}:{title:"Failed to Kill Process",message:"The process could not be terminated. It may have already exited or require elevated privileges."}}var _=require("child_process");var re={maxBuffer:10*1024*1024};async function oe(){return new Promise((e,t)=>{(0,_.exec)(z(),re,(n,a)=>{if(n){t(n);return}let b=(h?J(a):a.split(`
`).map(H).filter(Boolean)).filter(l=>l?.processName).map(l=>{let g=l.path||"",C=l.processName||"",y=X(g);return{id:l.id||0,pid:l.pid||0,cpu:l.cpu||0,mem:l.mem||0,type:y,path:g,processName:C,appName:y==="app"?Q(g,C):void 0}}).filter(l=>l.processName!=="");e(b)})})}async function ne(){return h?new Promise(e=>{(0,_.exec)(V(),re,(t,n)=>{if(t){console.error("Failed to fetch CPU performance data:",t),e(new Map);return}e(q(n))})}):new Map}var d=require("react/jsx-runtime"),F="kill-process.app-grouping-enabled",ke="kill-process.sort-by",se="cpu",De=e=>e==null?null:e===!0||e==="true"||e===1||e==="1"?!0:e===!1||e==="false"||e===0||e==="0"?!1:null,Re=e=>e==="cpu"||e==="memory";function ae(){let[e,t]=(0,N.useState)([]),[n,a]=(0,N.useState)([]),[p,b]=(0,N.useState)(""),l=(0,o.getPreferenceValues)(),g=l.shouldSearchInPaths,C=l.shouldSearchInPid,y=l.shouldPrioritizeAppsWhenFiltering,A=l.shouldShowPID,T=l.shouldShowPath,x=+l.refreshDuration,ce=l.closeWindowAfterKill,k=l.clearSearchBarAfterKill,le=l.goToRootAfterKill,pe=l.skipConfirmation,[D,ue]=(0,N.useState)(se),[$,E]=(0,N.useState)(!1),[R,de]=(0,N.useState)(new Map);(0,N.useEffect)(()=>{(async()=>{let s=await o.LocalStorage.getItem(F);if(typeof s=="boolean"){E(s);return}let i=De(s);i!=null&&(E(i),await o.LocalStorage.setItem(F,i))})()},[]);let W=()=>{oe().then(r=>{h&&R.size>0&&(r=r.map(s=>{let i=R.get(s.id);return i!==void 0?{...s,cpu:i}:s})),t(r),h&&ne().then(s=>{s.size>0&&(de(s),t(i=>i.map(S=>{let f=s.get(S.id);return f!==void 0?{...S,cpu:f}:S})))})}).catch(r=>{console.error("Failed to fetch processes:",r),(0,o.showToast)({title:"Failed to fetch processes",style:o.Toast.Style.Failure,message:r instanceof Error?r.message:"Unknown error"})})};v(W,x),(0,N.useEffect)(()=>{let r=e;$&&(r=he(r)),r.sort((s,i)=>D==="memory"?s.mem>i.mem?-1:1:s.cpu>i.cpu?-1:1),a(r)},[e,D,$]);let fe=r=>ee(r),K=async(r,s=!1)=>{let i=r.processName==="-"?`process ${r.id}?`:r.processName;if(!pe&&!await(0,o.confirmAlert)({title:`${s?"Force ":""}Kill ${i}?`,rememberUserChoice:!0})){(0,o.showToast)({title:`Cancelled Killing ${i}`,style:o.Toast.Style.Failure});return}let S=Z(r.id,s);(0,ie.exec)(S,f=>{if(f){let P=te(s);s&&P.helpUrl?(0,o.confirmAlert)({title:P.title,message:P.message,primaryAction:{title:"Open Help",onAction:()=>(0,o.open)(P.helpUrl)}}):(0,o.showToast)({title:P.title,message:P.message,style:o.Toast.Style.Failure});return}(0,o.showToast)({title:`Killed ${i}`,style:o.Toast.Style.Success})}),t(n.filter(f=>f.id!==r.id)),ce&&(0,o.closeMainWindow)(),le&&(0,o.popToRoot)({clearSearchBar:k}),k&&(0,o.clearSearchBar)({forceScrollToTop:!0})},me=r=>{let s=[],S=(r.processName?.trim()??"").toLowerCase(),f=P=>{let c=P?.trim();c&&c.toLowerCase()!==S&&(s.some(m=>m.toLowerCase()===c.toLowerCase())||s.push(c))};return r.type==="aggregatedApp"&&f(r.appName),A&&f(r.id.toString()),T&&f(r.path),s.length>0?s.join(" - "):void 0},he=r=>{let s=Array(),i=new Map;i.set(1,{process:{id:1},childNodes:[]});let S=Array();r.forEach(c=>{if(c.type==="app"){S.push(c.id);let m=i.get(c.id);m==null?(m={process:c,childNodes:[]},i.set(c.id,m)):m.process=c;let u=i.get(c.pid);if(u==null)u={process:void 0,childNodes:[m]},i.set(c.pid,u);else if(u.process==null)u.childNodes.push(m);else{let w;for(;u?.process!=null&&u.process.pid!==1&&(w=i.get(u.process.pid))!=null;)u=w;u?.childNodes.push(m)}u.process?.id!==1&&(u.childNodes=u.childNodes.concat(m.childNodes),m.childNodes=[])}else s.push(c)});let f=i.get(1)?.childNodes,P=Array();return f?.forEach(c=>{if(c.process==null)return;P.push(c.process.id);let m=c.childNodes.map(u=>u.process?.id).filter(u=>u!=null);P=P.concat(m),s.push({id:c.process.id,pid:c.process.pid,cpu:(c.childNodes?.reduce((u,w)=>u+(w.process?.cpu??0),0)??0)+c.process.cpu,mem:(c.childNodes?.reduce((u,w)=>u+(w.process?.mem??0),0)??0)+c.process.mem,type:"aggregatedApp",path:c.process.path,processName:c.process.processName,appName:c.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),s},ge=async()=>{let r=!$;await o.LocalStorage.setItem(F,r),E(r),await(0,o.showToast)({title:`${r?"Enabled":"Disabled"} App Grouping`})},Pe=n.length;return(0,d.jsx)(o.List,{isLoading:n.length===0,searchBarPlaceholder:"Filter by name",onSearchTextChange:r=>b(r),searchBarAccessory:(0,d.jsx)(o.List.Dropdown,{id:ke,tooltip:"Sort",storeValue:!0,defaultValue:se,onChange:r=>{Re(r)&&ue(r)},children:(0,d.jsxs)(o.List.Dropdown.Section,{title:"Sort By",children:[(0,d.jsx)(o.List.Dropdown.Item,{title:"CPU Usage",value:"cpu"}),(0,d.jsx)(o.List.Dropdown.Item,{title:"Memory Usage",value:"memory"})]})}),children:(0,d.jsx)(o.List.Section,{title:"Processes",subtitle:`${Pe} running`,children:n.filter(r=>{if(p==="")return!0;let s=r.processName.toLowerCase().includes(p.toLowerCase()),i=g&&r.path.toLowerCase().match(new RegExp(`.+${p}.*\\.[app|framework|prefpane]`,"ig"))!=null,S=C&&r.id.toString().includes(p),f=r.type==="aggregatedApp"&&r.appName?.toLowerCase().includes(p.toLowerCase());return s||i||S||f}).sort((r,s)=>{if(y){let i=["app","aggregatedApp"];if(i.includes(r.type)&&!i.includes(s.type))return-1;if(!i.includes(r.type)&&i.includes(s.type))return 1}return 0}).map((r,s)=>{let i=fe(r);return(0,d.jsx)(o.List.Item,{title:r.processName,subtitle:me(r),icon:i,accessories:[{text:`${r.cpu.toFixed(2)}%`,icon:{source:"cpu.svg",tintColor:o.Color.PrimaryText},tooltip:"% CPU"},{text:M(r.mem*1024),icon:{source:"memorychip.svg",tintColor:o.Color.PrimaryText},tooltip:"Memory"}],actions:(0,d.jsxs)(o.ActionPanel,{children:[(0,d.jsx)(o.Action,{title:"Kill",icon:o.Icon.XMarkCircle,onAction:()=>K(r)}),(0,d.jsx)(o.Action,{title:"Force Kill",icon:o.Icon.XMarkCircle,onAction:()=>K(r,!0)}),r.path==null?null:(0,d.jsx)(o.Action.CopyToClipboard,{title:"Copy Path",content:r.path,shortcut:o.Keyboard.Shortcut.Common.CopyPath}),(0,d.jsx)(o.Action,{title:"Reload",icon:o.Icon.ArrowClockwise,shortcut:o.Keyboard.Shortcut.Common.Refresh,onAction:()=>W()}),(0,d.jsx)(o.Action,{title:`${$?"Disable":"Enable"} App Grouping`,icon:o.Icon.AppWindow,shortcut:{modifiers:["shift"],key:"tab"},onAction:ge})]})},s)})})})}
